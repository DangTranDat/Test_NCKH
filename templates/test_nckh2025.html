<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giám sát lũ lụt và sạt lở</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f0f5f9;
            color: #333;
        }
        #content {
            max-width: 1200px;
            margin: auto;
            padding: 30px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .section {
            margin-top: 40px;
        }
        .chart {
            width: 100%;
            height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ccc;
        }
        th {
            background-color: #f7f7f7;
        }
        .footer {
            margin-top: 50px;
            text-align: center;
            padding: 15px;
            background-color: #2c3e50;
            color: #fff;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="content">
        <h1>Giám sát lũ lụt và sạt lở</h1>

        <div class="section">
            <h2>Biểu đồ các thông số</h2>
            <div id="disasterChart" class="chart"></div>
            <p><em>Các đường đứt nét biểu thị xu hướng dự đoán.</em></p>
        </div>

        <div class="section">
            <h2>Bảng dữ liệu hiện tại</h2>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Thời gian</th>
                        <th>Mực nước (cm)</th>
                        <th>Lượng mưa (mm)</th>
                        <th>Độ ẩm đất (%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <h2>Thống kê tổng hợp</h2>
            <div id="statistics"></div>
        </div>
    </div>

    <div class="footer">
        &copy; 2025 Giám sát thiên tai - Nhóm phát triển IoT
    </div>

    <script>
        fetch('/api/chart-data')
            .then(response => response.json())
            .then(data => {
                const timestamps = data.timestamps;
                const waterLevel = data.water_level;
                const rainfall = data.rainfall;
                const soilMoisture = data.soil_moisture;

                const futureTimestamps = data.future_timestamps;
                const predictedWaterLevel = data.predicted_water_level;
                const predictedRainfall = data.predicted_rainfall;
                const predictedSoilMoisture = data.predicted_soil_moisture;

                // Populate table
                const tableBody = document.querySelector('#dataTable tbody');
                tableBody.innerHTML = '';
                const displayCount = 20;
                const start = Math.max(0, timestamps.length - displayCount);
                for (let i = start; i < timestamps.length; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${timestamps[i]}</td>
                        <td>${waterLevel[i]}</td>
                        <td>${rainfall[i]}</td>
                        <td>${soilMoisture[i]}</td>
                    `;
                    tableBody.appendChild(row);
                }

                // Plot chart
                const traceWater = {
                    x: timestamps, y: waterLevel,
                    type: 'scatter', mode: 'lines+markers',
                    name: 'Mực nước (cm)', line: { color: 'blue' }
                };

                const traceRain = {
                    x: timestamps, y: rainfall,
                    type: 'scatter', mode: 'lines+markers',
                    name: 'Lượng mưa (mm)', line: { color: 'green' }
                };

                const traceSoil = {
                    x: timestamps, y: soilMoisture,
                    type: 'scatter', mode: 'lines+markers',
                    name: 'Độ ẩm đất (%)', line: { color: 'orange' }
                };

                const traceWaterPred = {
                    x: futureTimestamps, y: predictedWaterLevel,
                    type: 'scatter', mode: 'lines',
                    name: 'Dự đoán mực nước', line: { color: 'blue', dash: 'dash' }
                };

                const traceRainPred = {
                    x: futureTimestamps, y: predictedRainfall,
                    type: 'scatter', mode: 'lines',
                    name: 'Dự đoán lượng mưa', line: { color: 'green', dash: 'dash' }
                };

                const traceSoilPred = {
                    x: futureTimestamps, y: predictedSoilMoisture,
                    type: 'scatter', mode: 'lines',
                    name: 'Dự đoán độ ẩm đất', line: { color: 'orange', dash: 'dash' }
                };

                const layout = {
                    title: 'Giám sát và dự đoán thiên tai',
                    xaxis: { title: 'Thời gian' },
                    yaxis: { title: 'Giá trị' }
                };

                Plotly.newPlot('disasterChart', [
                    traceWater, traceRain, traceSoil,
                    traceWaterPred, traceRainPred, traceSoilPred
                ], layout);

                // Display statistics
                const stats = data.statistics;
                const statsDiv = document.getElementById('statistics');
                statsDiv.innerHTML = `
                    <table>
                        <thead><tr><th>Thông số</th><th>Giá trị</th></tr></thead>
                        <tbody>
                            <tr><td>Trung bình mực nước</td><td>${stats.water_mean.toFixed(1)} cm</td></tr>
                            <tr><td>Trung bình lượng mưa</td><td>${stats.rainfall_mean.toFixed(1)} mm</td></tr>
                            <tr><td>Trung bình độ ẩm đất</td><td>${stats.soil_moisture_mean.toFixed(1)} %</td></tr>
                            <tr><td>Thời điểm tính toán</td><td>${stats.timestamp}</td></tr>
                        </tbody>
                    </table>
                `;
            })
            .catch(error => console.error('Lỗi khi lấy dữ liệu:', error));
    </script>
</body>
</html>
