<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gi√°m s√°t & D·ª± ƒëo√°n Thi√™n tai</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 0;
    }
    #container {
      max-width: 1200px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .chart, .table-container {
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.9em;
      background-color: #333;
      color: white;
      margin-top: 30px;
    }
    #alertSection {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      display: none;
    }
    .alert-item {
      margin-bottom: 8px;
      padding: 10px 12px;
      border-radius: 5px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }
    .alert-icon {
      margin-right: 10px;
      font-size: 1.4em;
    }
    .alert-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }
    .alert-danger {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .alert-info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>H·ªá th·ªëng Gi√°m s√°t & D·ª± ƒëo√°n Thi√™n tai</h1>

    <!-- C·∫£nh b√°o -->
    <div id="alertSection">
      <h2>C·∫£nh b√°o</h2>
      <div id="alertList"></div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="chart"><div id="rainSoilWaterChart" style="height: 400px;"></div></div>
    <div class="chart"><div id="gyroChart" style="height: 400px;"></div></div>
    <div class="chart"><div id="vibrationChart" style="height: 300px;"></div></div>
    <div class="chart"><div id="tempChart" style="height: 400px;"></div></div>
    <div class="chart"><div id="humidityChart" style="height: 400px;"></div></div>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div class="table-container">
      <h2>D·ªØ li·ªáu g·∫ßn nh·∫•t</h2>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Th·ªùi gian</th>
            <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
            <th>ƒê·ªô ·∫©m (%)</th>
            <th>M·ª±c n∆∞·ªõc</th>
            <th>L∆∞·ª£ng m∆∞a</th>
            <th>ƒê·ªô ·∫©m ƒë·∫•t</th>
            <th>√Åp su·∫•t</th>
            <th>Rung ƒë·ªông</th>
            <th>Gyro X</th>
            <th>Gyro Y</th>
            <th>Gyro Z</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Th·ªëng k√™ -->
    <div class="table-container" id="statisticsSection">
      <h2>Th·ªëng k√™</h2>
      <div id="statisticsTable"></div>
    </div>

    <!-- Ma tr·∫≠n t∆∞∆°ng quan -->
    <div class="table-container" id="correlationSection">
      <h2>Ma tr·∫≠n t∆∞∆°ng quan</h2>
      <div id="correlationMatrix"></div>
    </div>
  </div>

  <div class="footer">
    &copy; 2025 H·ªá th·ªëng Gi√°m s√°t Thi√™n tai. All rights reserved.
  </div>

  <script>
    function renderAlerts(alerts) {
      const alertSection = document.getElementById('alertSection');
      const alertList = document.getElementById('alertList');
      alertList.innerHTML = '';
      if (!alerts || alerts.length === 0) {
        alertSection.style.display = 'none';
        return;
      }
      let lastAlert = null;
      for (let i = alerts.length - 1; i >= 0; i--) {
        if (alerts[i] && alerts[i].trim() !== '') {
          lastAlert = alerts[i];
          break;
        }
      }
      if (!lastAlert) {
        alertSection.style.display = 'none';
        return;
      }
      alertSection.style.display = 'block';
      const div = document.createElement('div');
      div.classList.add('alert-item', 'alert-warning');
      if (lastAlert.includes("NGUY CO") || lastAlert.includes("LU LUT") || lastAlert.includes("SAT LO")) {
        div.classList.replace('alert-warning', 'alert-danger');
      } else if (lastAlert.includes("MUA") || lastAlert.includes("DO AM")) {
        div.classList.replace('alert-warning', 'alert-info');
      }
      const iconSpan = document.createElement('span');
      iconSpan.classList.add('alert-icon');
      iconSpan.textContent = lastAlert.includes("NGUY CO") || lastAlert.includes("LU LUT") || lastAlert.includes("SAT LO") ? '‚ö†Ô∏è' :
                             lastAlert.includes("MUA") || lastAlert.includes("DO AM") ? 'üîî' : '‚ö†Ô∏è';
      div.appendChild(iconSpan);
      div.appendChild(document.createTextNode(lastAlert));
      alertList.appendChild(div);
    }

    function plotCharts(data, predict) {
      const colors = {
        temperature: 'red',
        humidity: 'blue',
        water_level: 'green',
        rain_level: 'orange',
        soil_moisture: 'purple',
        pressure: 'brown',
        vibration: 'teal',
        gyro_x: 'pink',
        gyro_y: 'gray',
        gyro_z: 'cyan'
      };

      function createTrace(field, label, type = 'line') {
        return {
          x: data.timestamps,
          y: data[`${field}s`],
          type: type === 'bar' ? 'bar' : 'scatter',
          mode: 'lines+markers',
          name: `${label} (th·ª±c t·∫ø)`,
          line: { color: colors[field] || 'black' }
        };
      }

      function createPredictionTrace(field, label) {
        const pred = predict.prediction[field];
        if (!pred || !pred.predicted_next) return null;
        const futureX = pred.predicted_next.map((_, i) => `T+${i + 1}`);
        return {
          x: futureX,
          y: pred.predicted_next,
          mode: 'lines',
          name: `${label} (d·ª± ƒëo√°n)`,
          line: { dash: 'dot', color: colors[field] || 'gray' }
        };
      }

      Plotly.newPlot('tempChart', [
        createTrace('temperature', 'Nhi·ªát ƒë·ªô'),
        createPredictionTrace('temperature', 'Nhi·ªát ƒë·ªô')
      ].filter(Boolean), {
        title: 'Bi·ªÉu ƒë·ªì Nhi·ªát ƒë·ªô',
        xaxis: { title: 'Th·ªùi gian' },
        yaxis: { title: '¬∞C' }
      });

      Plotly.newPlot('humidityChart', [
        createTrace('humidity', 'ƒê·ªô ·∫©m'),
        createPredictionTrace('humidity', 'ƒê·ªô ·∫©m')
      ].filter(Boolean), {
        title: 'Bi·ªÉu ƒë·ªì ƒê·ªô ·∫©m',
        xaxis: { title: 'Th·ªùi gian' },
        yaxis: { title: '%' }
      });

      Plotly.newPlot('gyroChart', [
        createTrace('gyro_x', 'Gyro X'),
        createPredictionTrace('gyro_x', 'Gyro X'),
        createTrace('gyro_y', 'Gyro Y'),
        createPredictionTrace('gyro_y', 'Gyro Y'),
        createTrace('gyro_z', 'Gyro Z'),
        createPredictionTrace('gyro_z', 'Gyro Z')
      ].filter(Boolean), {
        title: 'Gyroscope (X, Y, Z)',
        xaxis: { title: 'Th·ªùi gian' },
        yaxis: { title: 'Gi√° tr·ªã' }
      });

      Plotly.newPlot('rainSoilWaterChart', [
        createTrace('rain_level', 'L∆∞·ª£ng m∆∞a'),
        createPredictionTrace('rain_level', 'L∆∞·ª£ng m∆∞a'),
        createTrace('water_level', 'M·ª±c n∆∞·ªõc'),
        createPredictionTrace('water_level', 'M·ª±c n∆∞·ªõc'),
        createTrace('soil_moisture', 'ƒê·ªô ·∫©m ƒë·∫•t'),
        createPredictionTrace('soil_moisture', 'ƒê·ªô ·∫©m ƒë·∫•t')
      ].filter(Boolean), {
        title: 'L∆∞·ª£ng m∆∞a - M·ª±c n∆∞·ªõc - ƒê·ªô ·∫©m ƒë·∫•t',
        xaxis: { title: 'Th·ªùi gian' },
        yaxis: { title: 'Gi√° tr·ªã' }
      });

      const vibrationBinary = data.vibrations.map(v => v === true || v === "True" ? 1 : 0);
      Plotly.newPlot('vibrationChart', [{
        x: data.timestamps,
        y: vibrationBinary,
        type: 'bar',
        name: 'Rung ƒë·ªông',
        marker: { color: 'teal' }
      }], {
        title: 'Rung ƒë·ªông (1 = C√≥, 0 = Kh√¥ng)',
        xaxis: { title: 'Th·ªùi gian' },
        yaxis: { tickvals: [0, 1], ticktext: ['Kh√¥ng', 'C√≥'], title: 'Tr·∫°ng th√°i' }
      });
    }

    async function loadData() {
      try {
        const [dataRes, predictRes] = await Promise.all([
          fetch('/data'),
          fetch('/predict')
        ]);
        const data = await dataRes.json();
        const predict = await predictRes.json();
        renderAlerts(data.canhbao || []);
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < data.timestamps.length; i++) {
          const row = document.createElement('tr');
          [
            data.timestamps[i],
            data.temperatures[i],
            data.humidities[i],
            data.water_levels[i],
            data.rains_level[i],
            data.soil_moistures[i],
            data.pressures[i],
            data.vibrations[i],
            data.gyro_xs[i],
            data.gyro_ys[i],
            data.gyro_zs[i]
          ].forEach(value => {
            const cell = document.createElement('td');
            cell.innerText = value;
            row.appendChild(cell);
          });
          tbody.appendChild(row);
        }

        plotCharts(data, predict);

        // Th·ªëng k√™
        const stats = predict.statistics;
        let statsHTML = '<table><thead><tr><th>Th√¥ng s·ªë</th><th>Trung b√¨nh</th><th>ƒê·ªô l·ªách chu·∫©n</th><th>Min</th><th>Max</th></tr></thead><tbody>';
        for (const key in stats) {
          statsHTML += `<tr>
            <td>${key}</td>
            <td>${stats[key].mean}</td>
            <td>${stats[key].std}</td>
            <td>${stats[key].min}</td>
            <td>${stats[key].max}</td>
          </tr>`;
        }
        statsHTML += '</tbody></table>';
        document.getElementById('statisticsTable').innerHTML = statsHTML;

        // Ma tr·∫≠n t∆∞∆°ng quan
        const corr = predict.correlation_matrix;
        const params = Object.keys(corr);
        let corrHTML = '<table><thead><tr><th></th>';
        params.forEach(p => corrHTML += `<th>${p}</th>`);
        corrHTML += '</tr></thead><tbody>';
        params.forEach(row => {
          corrHTML += `<tr><td>${row}</td>`;
          params.forEach(col => {
            corrHTML += `<td>${corr[row][col]}</td>`;
          });
          corrHTML += '</tr>';
        });
        corrHTML += '</tbody></table>';
        document.getElementById('correlationMatrix').innerHTML = corrHTML;

      } catch (err) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
      }
    }

    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>
