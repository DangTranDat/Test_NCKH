<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giám sát và Dự báo Thời gian thực</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f7fa;
            color: #333;
        }
        #content {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
        }
        .section {
            margin: 30px 0;
        }
        .chart {
            height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        .table-container {
            overflow-x: auto;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background: #333;
            color: #fff;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="content">
        <h1>Giám sát & Dự báo Thiên tai</h1>

        <div class="section">
            <div id="envChart" class="chart"></div>
        </div>

        <div class="section">
            <h2>Dữ liệu Gần đây</h2>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Nhiệt độ (°C)</th>
                            <th>Độ ẩm (%)</th>
                            <th>Mực nước</th>
                            <th>Lượng mưa</th>
                            <th>Độ ẩm đất</th>
                            <th>Áp suất</th>
                            <th>Rung</th>
                            <th>Gyro X</th>
                            <th>Gyro Y</th>
                            <th>Gyro Z</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>Thống kê</h2>
            <div id="statistics" class="table-container"></div>
        </div>

        <div class="section">
            <h2>Ma trận tương quan</h2>
            <div id="correlationMatrix" class="table-container"></div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2025 Hệ thống dự báo thiên tai</p>
    </div>

    <script>
        function loadData() {
            fetch('/data')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = '';
                    for (let i = 0; i < data.timestamps.length; i++) {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${data.timestamps[i]}</td>
                            <td>${data.temperatures[i]}</td>
                            <td>${data.humidities[i]}</td>
                            <td>${data.water_levels[i]}</td>
                            <td>${data.rains_level[i]}</td>
                            <td>${data.soil_moistures[i]}</td>
                            <td>${data.pressures[i]}</td>
                            <td>${data.vibrations[i]}</td>
                            <td>${data.gyro_xs[i]}</td>
                            <td>${data.gyro_ys[i]}</td>
                            <td>${data.gyro_zs[i]}</td>
                        `;
                    }

                    Plotly.newPlot('envChart', [
                        {
                            x: data.timestamps,
                            y: data.water_levels,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Mực nước',
                            line: { color: 'blue' }
                        },
                        {
                            x: data.timestamps,
                            y: data.rains_level,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Lượng mưa',
                            line: { color: 'green' }
                        },
                        {
                            x: data.timestamps,
                            y: data.soil_moistures,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Độ ẩm đất',
                            line: { color: 'brown' }
                        }
                    ], {
                        title: 'Biểu đồ mực nước, lượng mưa và độ ẩm đất',
                        xaxis: { title: 'Thời gian' },
                        yaxis: { title: 'Giá trị' }
                    });
                });
        }

        function loadPrediction() {
            fetch('/predict')
                .then(res => res.json())
                .then(data => {
                    const stats = data.statistics;
                    const statDiv = document.getElementById('statistics');
                    statDiv.innerHTML = '<table><thead><tr><th>Thông số</th><th>Giá trị</th></tr></thead><tbody>' +
                        Object.entries(stats).map(([key, val]) =>
                            `<tr><td>${key}</td><td>${val}</td></tr>`
                        ).join('') + '</tbody></table>';

                    const corr = data.correlation_matrix;
                    const keys = Object.keys(corr);
                    let corrHtml = '<table><thead><tr><th></th>' +
                        keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
                    keys.forEach(k1 => {
                        corrHtml += `<tr><td>${k1}</td>` +
                            keys.map(k2 => `<td>${corr[k1][k2]}</td>`).join('') + '</tr>';
                    });
                    corrHtml += '</tbody></table>';
                    document.getElementById('correlationMatrix').innerHTML = corrHtml;
                });
        }

        loadData();
        loadPrediction();
        setInterval(() => {
            loadData();
            loadPrediction();
        }, 60000);
    </script>
</body>
</html>
