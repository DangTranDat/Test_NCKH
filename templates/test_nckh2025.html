<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gi√°m s√°t & D·ª± ƒëo√°n Thi√™n tai</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f7fa;
            margin: 0;
            padding: 0;
        }
        #container {
            max-width: 1200px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .chart, .table-container {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            background-color: #333;
            color: white;
            margin-top: 30px;
        }
        #alertSection {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        .alert-item {
            margin-bottom: 8px;
            padding: 10px 12px;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .alert-icon {
            margin-right: 10px;
            font-size: 1.4em;
        }
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
<div id="container">
    <h1>H·ªá th·ªëng Gi√°m s√°t & D·ª± ƒëo√°n Thi√™n tai</h1>

    <!-- C·∫£nh b√°o -->
    <div id="alertSection">
        <h2>C·∫£nh b√°o</h2>
        <div id="alertList"></div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="chart">
        <div id="tempHumidityChart" style="height: 400px;"></div>
        <div id="gyroChart" style="height: 400px; margin-top: 30px;"></div>
        <div id="waterRainSoilChart" style="height: 400px; margin-top: 30px;"></div>
        <div id="vibrationChart" style="height: 200px; margin-top: 30px;"></div>    
    </div>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div class="table-container">
        <h2>D·ªØ li·ªáu g·∫ßn nh·∫•t</h2>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
                    <th>ƒê·ªô ·∫©m (%)</th>
                    <th>M·ª±c n∆∞·ªõc</th>
                    <th>L∆∞·ª£ng m∆∞a</th>
                    <th>ƒê·ªô ·∫©m ƒë·∫•t</th>
                    <th>√Åp su·∫•t</th>
                    <th>Rung ƒë·ªông</th>
                    <th>Gyro X</th>
                    <th>Gyro Y</th>
                    <th>Gyro Z</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Th·ªëng k√™ -->
    <div class="table-container" id="statisticsSection">
        <h2>Th·ªëng k√™</h2>
        <div id="statisticsTable"></div>
    </div>

    <!-- Ma tr·∫≠n t∆∞∆°ng quan -->
    <div class="table-container" id="correlationSection">
        <h2>Ma tr·∫≠n t∆∞∆°ng quan</h2>
        <div id="correlationMatrix"></div>
    </div>
    <!-- D·ª± ƒëo√°n xu h∆∞·ªõng -->
    <div class="table-container" id="predictionSection" style="margin-top:30px;">
        <h2>D·ª± ƒëo√°n xu h∆∞·ªõng 5 b∆∞·ªõc ti·∫øp theo</h2>
        <div id="predictionContent"></div>
    </div>
</div>

<div class="footer">
    &copy; 2025 H·ªá th·ªëng Gi√°m s√°t Thi√™n tai. All rights reserved.
</div>

<script>
    function renderAlerts(alerts) {
    const alertSection = document.getElementById('alertSection');
    const alertList = document.getElementById('alertList');
    alertList.innerHTML = '';

    // Ki·ªÉm tra m·∫£ng alerts c√≥ h·ª£p l·ªá v√† c√≥ √≠t nh·∫•t 1 ph·∫ßn t·ª≠
    if (!alerts || alerts.length === 0) {
        alertSection.style.display = 'none';
        return;
    }

    // L·∫•y ph·∫ßn t·ª≠ cu·ªëi c√πng
    const lastRawAlert = alerts[alerts.length - 1];
    const lastAlert = lastRawAlert ? lastRawAlert.trim() : '';

    // N·∫øu ph·∫ßn t·ª≠ cu·ªëi l√† chu·ªói r·ªóng ho·∫∑c ch·ªâ kho·∫£ng tr·∫Øng -> t·∫Øt c·∫£nh b√°o
    if (!lastAlert) {
        alertSection.style.display = 'none';
        return;
    }

    // C√≥ c·∫£nh b√°o, hi·ªÉn th·ªã
    alertSection.style.display = 'block';

    const div = document.createElement('div');
    div.classList.add('alert-item', 'alert-warning');

    // X√°c ƒë·ªãnh m·ª©c ƒë·ªô c·∫£nh b√°o
    if (lastAlert.includes("NGUY CO") || lastAlert.includes("LU LUT") || lastAlert.includes("SAT LO")) {
        div.classList.replace('alert-warning', 'alert-danger');
    } else if (lastAlert.includes("MUA") || lastAlert.includes("DO AM")) {
        div.classList.replace('alert-warning', 'alert-info');
    }

    const iconSpan = document.createElement('span');
    iconSpan.classList.add('alert-icon');
    iconSpan.textContent = lastAlert.includes("NGUY CO") || lastAlert.includes("LU LUT") || lastAlert.includes("SAT LO") ? '‚ö†Ô∏è' :
                            lastAlert.includes("MUA") || lastAlert.includes("DO AM") ? 'üîî' : '‚ö†Ô∏è';

    div.appendChild(iconSpan);
    div.appendChild(document.createTextNode(' ' + lastAlert));
    alertList.appendChild(div);
}

    async function loadData() {
    try {
        const [dataRes, predictRes] = await Promise.all([
            fetch('/data'),
            fetch('/predict')
        ]);

        const data = await dataRes.json();
        const predict = await predictRes.json();

        // ==== Hi·ªÉn th·ªã c·∫£nh b√°o t·ª´ /data ==== 
        const alerts = data.canhbao || [];
        renderAlerts(alerts);

        // ==== Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu g·∫ßn nh·∫•t ====
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < data.timestamps.length; i++) {
            const row = document.createElement('tr');
            [
                data.timestamps[i],
                data.temperatures[i],
                data.humidities[i],
                data.water_levels[i],
                data.rains_level[i],
                data.soil_moistures[i],
                data.pressures[i],
                data.vibrations[i],
                data.gyro_xs[i],
                data.gyro_ys[i],
                data.gyro_zs[i]
            ].forEach(value => {
                const cell = document.createElement('td');
                cell.innerText = value;
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        }

        // ==== Hi·ªÉn th·ªã Th·ªëng k√™ ====
        const statsDiv = document.getElementById('statisticsTable');
        const stats = predict.statistics;
        if (stats) {
            let html = '<table><thead><tr><th>Tham s·ªë</th><th>Gi√° tr·ªã trung b√¨nh</th><th>ƒê·ªô l·ªách chu·∫©n</th><th>Gi√° tr·ªã nh·ªè nh·∫•t</th><th>Gi√° tr·ªã l·ªõn nh·∫•t</th></tr></thead><tbody>';
            for (const param in stats) {
                html += `<tr>
                    <td>${param}</td>
                    <td>${stats[param].mean}</td>
                    <td>${stats[param].std}</td>
                    <td>${stats[param].min}</td>
                    <td>${stats[param].max}</td>
                </tr>`;
            }
            html += '</tbody></table>';
            statsDiv.innerHTML = html;
        }

        // ==== Hi·ªÉn th·ªã Ma tr·∫≠n t∆∞∆°ng quan ====
        const corrDiv = document.getElementById('correlationMatrix');
        const corr = predict.correlation_matrix;
        if (corr) {
            let html = '<table><thead><tr><th></th>';
            const keys = Object.keys(corr);
            keys.forEach(k => { html += `<th>${k}</th>` });
            html += '</tr></thead><tbody>';

            keys.forEach(rowKey => {
                html += `<tr><th>${rowKey}</th>`;
                keys.forEach(colKey => {
                    html += `<td>${corr[rowKey][colKey].toFixed(2)}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            corrDiv.innerHTML = html;
        }

        // ==== Hi·ªÉn th·ªã D·ª± ƒëo√°n xu h∆∞·ªõng ====
        const predictionDiv = document.getElementById('predictionContent');
        const predictions = predict.prediction;
        if (predictions) {
            let html = '';
            for (const param in predictions) {
                const pred = predictions[param];
                if (pred.error) {
                    html += `<p><b>${param}:</b> ${pred.error}</p>`;
                    continue;
                }
                html += `<div style="margin-bottom:20px;">
                    <h3>${param}</h3>
                    <p><b>5 gi√° tr·ªã cu·ªëi c√πng:</b> ${pred.last_values.map(v => v.toFixed ? v.toFixed(2) : v).join(', ')}</p>
                    <p><b>D·ª± ƒëo√°n 5 b∆∞·ªõc ti·∫øp theo:</b> ${pred.predicted_next.map(v => v.toFixed ? v.toFixed(2) : v).join(', ')}</p>
                </div>`;
            }
            predictionDiv.innerHTML = html;
        }

        // ==== TODO: V·∫Ω bi·ªÉu ƒë·ªì ====
        // B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c d√πng d·ªØ li·ªáu 'data' v√† 'predict' ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì theo √Ω mu·ªën.
                function drawCharts(data, predict) {
    const timestamps = data.timestamps;

    // 1. Nhi·ªát ƒë·ªô & ƒê·ªô ·∫©m
    const tempTrace = {
        x: timestamps,
        y: data.temperatures,
        name: 'Nhi·ªát ƒë·ªô (¬∞C)',
        mode: 'lines+markers',
        line: {color: 'red'}
    };
    const tempPredictTrace = {
        x: [...timestamps.slice(-5), ...Array.from({length: 5}, (_, i) => `D·ª± ƒëo√°n +${i+1}`)],
        y: [...predict.prediction.temperature.last_values, ...predict.prediction.temperature.predicted_next],
        name: 'D·ª± ƒëo√°n Nhi·ªát ƒë·ªô',
        mode: 'lines+markers',
        line: {color: 'red', dash: 'dash'}
    };
    const humidityTrace = {
        x: timestamps,
        y: data.humidities,
        name: 'ƒê·ªô ·∫©m (%)',
        mode: 'lines+markers',
        line: {color: 'blue'}
    };
    const humidityPredictTrace = {
        x: [...timestamps.slice(-5), ...Array.from({length: 5}, (_, i) => `D·ª± ƒëo√°n +${i+1}`)],
        y: [...predict.prediction.humidity.last_values, ...predict.prediction.humidity.predicted_next],
        name: 'D·ª± ƒëo√°n ƒê·ªô ·∫©m',
        mode: 'lines+markers',
        line: {color: 'blue', dash: 'dash'}
    };

    Plotly.newPlot('tempHumidityChart', 
        [tempTrace, tempPredictTrace, humidityTrace, humidityPredictTrace],
        {title: 'Nhi·ªát ƒë·ªô & ƒê·ªô ·∫©m', xaxis: {title: 'Th·ªùi gian'}, yaxis: {title: 'Gi√° tr·ªã'}});

    // 2. Gyro X, Y, Z
    const gyroXTrace = {
        x: timestamps,
        y: data.gyro_xs,
        name: 'Gyro X',
        mode: 'lines+markers',
        line: {color: 'green'}
    };
    const gyroYTrace = {
        x: timestamps,
        y: data.gyro_ys,
        name: 'Gyro Y',
        mode: 'lines+markers',
        line: {color: 'orange'}
    };
    const gyroZTrace = {
        x: timestamps,
        y: data.gyro_zs,
        name: 'Gyro Z',
        mode: 'lines+markers',
        line: {color: 'purple'}
    };

    Plotly.newPlot('gyroChart',
        [gyroXTrace, gyroYTrace, gyroZTrace],
        {title: 'Gyroscope X/Y/Z', xaxis: {title: 'Th·ªùi gian'}, yaxis: {title: 'Gi√° tr·ªã'}});

    // 3. M·ª±c n∆∞·ªõc, L∆∞·ª£ng m∆∞a, ƒê·ªô ·∫©m ƒë·∫•t
    const waterLevelTrace = {
        x: timestamps,
        y: data.water_levels,
        name: 'M·ª±c n∆∞·ªõc',
        mode: 'lines+markers',
        line: {color: 'blue'}
    };
    const waterLevelPredictTrace = {
        x: [...timestamps.slice(-5), ...Array.from({length: 5}, (_, i) => `D·ª± ƒëo√°n +${i+1}`)],
        y: [...predict.prediction.water_level.last_values, ...predict.prediction.water_level.predicted_next],
        name: 'D·ª± ƒëo√°n M·ª±c n∆∞·ªõc',
        mode: 'lines+markers',
        line: {color: 'blue', dash: 'dash'}
    };
    const rainLevelTrace = {
        x: timestamps,
        y: data.rains_level,
        name: 'L∆∞·ª£ng m∆∞a',
        mode: 'lines+markers',
        line: {color: 'gray'}
    };
    const rainLevelPredictTrace = {
        x: [...timestamps.slice(-5), ...Array.from({length: 5}, (_, i) => `D·ª± ƒëo√°n +${i+1}`)],
        y: [...predict.prediction.rain_level.last_values, ...predict.prediction.rain_level.predicted_next],
        name: 'D·ª± ƒëo√°n L∆∞·ª£ng m∆∞a',
        mode: 'lines+markers',
        line: {color: 'gray', dash: 'dash'}
    };
    const soilMoistureTrace = {
        x: timestamps,
        y: data.soil_moistures,
        name: 'ƒê·ªô ·∫©m ƒë·∫•t',
        mode: 'lines+markers',
        line: {color: 'brown'}
    };
    const soilMoisturePredictTrace = {
        x: [...timestamps.slice(-5), ...Array.from({length: 5}, (_, i) => `D·ª± ƒëo√°n +${i+1}`)],
        y: [...predict.prediction.soil_moisture.last_values, ...predict.prediction.soil_moisture.predicted_next],
        name: 'D·ª± ƒëo√°n ƒê·ªô ·∫©m ƒë·∫•t',
        mode: 'lines+markers',
        line: {color: 'brown', dash: 'dash'}
    };

    Plotly.newPlot('waterRainSoilChart',
        [waterLevelTrace, waterLevelPredictTrace, rainLevelTrace, rainLevelPredictTrace, soilMoistureTrace, soilMoisturePredictTrace],
        {title: 'M·ª±c n∆∞·ªõc, L∆∞·ª£ng m∆∞a, ƒê·ªô ·∫©m ƒë·∫•t', xaxis: {title: 'Th·ªùi gian'}, yaxis: {title: 'Gi√° tr·ªã'}});

    // 4. Rung ƒë·ªông (True/False)
    // Hi·ªÉn th·ªã d·∫°ng bar v·ªõi gi√° tr·ªã 0 ho·∫∑c 1
    const vibrationTrace = {
        x: timestamps,
        y: data.vibrations,
        name: 'Rung ƒë·ªông th·ª±c t·∫ø',
        type: 'bar',
        marker: {color: 'purple'}
    };
    const vibrationPredictTrace = {
        x: [...timestamps.slice(-5), ...Array.from({length: 5}, (_, i) => `D·ª± ƒëo√°n +${i+1}`)],
        y: [...predict.prediction.vibration.last_values, ...predict.prediction.vibration.predicted_next],
        name: 'D·ª± ƒëo√°n Rung ƒë·ªông',
        mode: 'lines+markers',
        line: {color: 'purple', dash: 'dash'}
    };

    Plotly.newPlot('vibrationChart',
        [vibrationTrace, vibrationPredictTrace],
        {title: 'Rung ƒë·ªông (True/False)', xaxis: {title: 'Th·ªùi gian'}, yaxis: {title: 'Gi√° tr·ªã', range: [-0.2, 2]}});
}
        
drawCharts(data, predict);



    } catch (error) {
        console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
    }
}



    loadData();
    setInterval(loadData, 10000);
</script>
</body>
</html>




